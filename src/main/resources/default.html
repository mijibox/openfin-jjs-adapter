<html>
<head>
<script type="text/javascript">
var openFinApiGateway = (function() {
	let objectMap = new Map();
	let objId = 0;

	function setObject(obj) {
		let cachedObjId = "obj_" + objId++;
		objectMap.set(cachedObjId, obj);
		return cachedObjId;
	}

	function getObject(id) {
		return objectMap.get(id);	
	}

	function deleteObject(id) {
		objectMap.delete(id);
	}

	function invokeMethod(obj, method, ...args) {
		if (!obj) {
			var nObj = method.substring(0, method.lastIndexOf('.'));
			obj = eval(nObj); 
			return eval(method).call(obj, ...args);
		}
		else {
			return eval("obj." + method).call(obj, ...args);
		}
	}
	
	function sendMessage(dest, payload) {
		console.log("sending message: " + JSON.stringify(payload));
		fin.InterApplicationBus.send(dest, fin.me.uuid + '-exec', payload);
	}

	if (fin !== 'undefined') {
		console.log("running in OpenFin runtime.");
		fin.InterApplicationBus.subscribe({uuid: '*'}, fin.me.uuid + '-exec', (msg, srcIdentity) => {
			console.log("received message from: " + JSON.stringify(srcIdentity) + ", message: " + JSON.stringify(msg));
			let action = msg.action;
			let messageId = msg.messageId;
			let payload = msg.payload;
			if (action == 'ping') {
				sendMessage(srcIdentity, {action: 'pong', messageId, payload});
			}
			else if (action == 'invoke') {
				let targetObject = null;
				if (payload.cachedObjId) {
					targetObject = getObject(payload.cachedObjId);
				}
				let args = payload.args || [];
				//console.log("targetObject: " + JSON.stringify(targetObject));
				Promise.resolve(invokeMethod(targetObject, payload.method, ...args)).then(result=>{
					//console.log("invokeMethod: " + payload.method + ", got result: " + JSON.stringify(result));
					let resultPayload = {messageId, action: 'invoke-result', "payload": result};
					if (payload.cacheResultObj) {
						resultPayload.resultObjectId = setObject(result);
					}
					sendMessage(srcIdentity, resultPayload);
				});
			}
			else if (action == 'add-listener') {
				let listenerId = payload.listenerId;
				let targetObject = null;
				if (payload.cachedObjId) {
					targetObject = getObject(payload.cachedObjId);
				}
				let listener = function(e) {
					let topic = fin.me.uuid + '-listener-' + listenerId;
					console.log(topic + ": " + payload.event + " listener invoked: " + JSON.stringify(e));
					console.log("srcIdentity: " + JSON.stringify(srcIdentity));
					fin.InterApplicationBus.send(srcIdentity, topic, e);
				};
				let resultObjectId = setObject(listener);
				invokeMethod(targetObject, payload.method, payload.event, listener);
				let resultPayload = {messageId, action: 'add-listener-result', "payload": {resultObjectId}};
				sendMessage(srcIdentity, resultPayload);
			}
		});
		
		fin.System.addListener('window-closed', e=>{
			console.log("got window-closed event", JSON.stringify(e));
		})
		
		fin.Window.getCurrent().then(w=>{
			fin.System.showDeveloperTools(w.identity);
		});
	}
	else {
		console.log("not running in OpenFin runtime.");
	}
}());
</script>
</head>
<body>
	<h4>OpenFin Java-JavaScript Adapter</h4>
</body>
</html>